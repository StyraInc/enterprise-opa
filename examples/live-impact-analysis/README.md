# Live Impact Analysis Demo

## Setup containers:

- `docker compose up`: starts Enterprise OPA, and a request generator that'll send eval
  requests continuously.

## Prepare a policy change

- `next-bundle/policy-rego` is like `policy.rego`, but with an extra section:

```rego
# tester needs to delete its own data
allow if {
	path := split(input.path, "/")
	path[1] == "data"
	path[2] == "tester"
	input.method == "DELETE"
	input.username == "tester"
}
```

- `eopa build next-bundle`: produces `bundle.tar.gz` with the new policy

## Assess the change against live traffic with LIA

We're cautious first: sample 20% of the traffic, only record differences in results, for 10s:

```
$ eopa liactl record --bundle bundle.tar.gz --duration 10s --sample-rate 0.2
  ███████████████████████████████████████████████████████████████████████████ 100%
┌───────────────────────────────────────┬────────┬─────────┬─────────┬─────────────────────────────────────────────────────────────────┬──────────────┬───────────┬───────────┐
│                node_id                │ req_id │ value_a │ value_b │                              input                              │     path     │ eval_ns_a │ eval_ns_b │
├───────────────────────────────────────┼────────┼─────────┼─────────┼─────────────────────────────────────────────────────────────────┼──────────────┼───────────┼───────────┤
│ a26f4a99-8d63-4eb4-99d5-0cc021f07365  │   5397 │  false  │  true   │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ authz/allow  │     98730 │    105542 │
│ a26f4a99-8d63-4eb4-99d5-0cc021f07365  │   5438 │  false  │  true   │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ authz/allow  │    211199 │     82788 │
│ a26f4a99-8d63-4eb4-99d5-0cc021f07365  │   5471 │  false  │  true   │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ authz/allow  │    122148 │    197244 │
│ a26f4a99-8d63-4eb4-99d5-0cc021f07365  │   5576 │  false  │  true   │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ authz/allow  │     45621 │     66587 │
│ a26f4a99-8d63-4eb4-99d5-0cc021f07365  │   5810 │  false  │  true   │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ authz/allow  │     62518 │     83846 │
│ a26f4a99-8d63-4eb4-99d5-0cc021f07365  │   5986 │  false  │  true   │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ authz/allow  │    104516 │     95555 │
│ a26f4a99-8d63-4eb4-99d5-0cc021f07365  │   5998 │  false  │  true   │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ authz/allow  │     45852 │     71651 │
└───────────────────────────────────────┴────────┴─────────┴─────────┴─────────────────────────────────────────────────────────────────┴──────────────┴───────────┴───────────┘
```

Looks like it's all the same. Let's try to sample some more, and group the results:

```
$ eopa liactl record --bundle bundle.tar.gz --duration 5s --sample-rate 0.5 --group
  ███████████████████████████████████████████████████████████████████████████ 100%
┌──────────────┬─────────────────────────────────────────────────────────────────┬───┬─────────────────┬───────────────────┬────────────────┬────────────────┬───────────────────┬────────────────┬───────────────────┬─────────────────────┬──────────────────┬──────────────────┬─────────────────────┬──────────────────┐
│     path     │                              input                              │ n │ mean_primary_ns │ median_primary_ns │ min_primary_ns │ max_primary_ns │ stddev_primary_ns │ var_primary_ns │ mean_secondary_ns │ median_secondary_ns │ min_secondary_ns │ max_secondary_ns │ stddev_secondary_ns │ var_secondary_ns │
├──────────────┼─────────────────────────────────────────────────────────────────┼───┼─────────────────┼───────────────────┼────────────────┼────────────────┼───────────────────┼────────────────┼───────────────────┼─────────────────────┼──────────────────┼──────────────────┼─────────────────────┼──────────────────┤
│ authz/allow  │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │ 5 │         78442.6 │             65550 │          52451 │         131633 │ 33132.80525853493 │   1097782784.3 │            101202 │               84224 │            35320 │           226082 │   73588.25213646537 │     5415230852.5 │
└──────────────┴─────────────────────────────────────────────────────────────────┴───┴─────────────────┴───────────────────┴────────────────┴────────────────┴───────────────────┴────────────────┴───────────────────┴─────────────────────┴──────────────────┴──────────────────┴─────────────────────┴──────────────────┘
```

So it's only this one thing that changed! Exactly as we expected.

In the metrics, you also find that the evaluation before and after (primary and secondary)
has different performance characteristics.
That's to be expected, since before, we had a quick `default allow := false` response.

We can also assess the impact of other results (that are not different) that came from
the extra rule we've added, by passing `--equals`:

```
$ eopa liactl record --bundle bundle.tar.gz --duration 5s --sample-rate 0.5 --group --equals 
  ███████████████████████████████████████████████████████████████████████████ 100%
┌──────────────┬─────────────────────────────────────────────────────────────────┬─────┬─────────────────────┬───────────────────┬────────────────┬────────────────┬─────────────────────┬────────────────────┬─────────────────────┬─────────────────────┬──────────────────┬──────────────────┬─────────────────────┬────────────────────┐
│     path     │                              input                              │  n  │   mean_primary_ns   │ median_primary_ns │ min_primary_ns │ max_primary_ns │  stddev_primary_ns  │   var_primary_ns   │  mean_secondary_ns  │ median_secondary_ns │ min_secondary_ns │ max_secondary_ns │ stddev_secondary_ns │  var_secondary_ns  │
├──────────────┼─────────────────────────────────────────────────────────────────┼─────┼─────────────────────┼───────────────────┼────────────────┼────────────────┼─────────────────────┼────────────────────┼─────────────────────┼─────────────────────┼──────────────────┼──────────────────┼─────────────────────┼────────────────────┤
│ authz/allow  │ {"method":"DELETE","path":"\/data\/tester","username":"admin"}  │  16 │           77623.125 │             62440 │          46699 │         160696 │   33502.67959606614 │ 1122429540.1166666 │          148091.125 │              109307 │            70125 │           345865 │   90362.39738436558 │      8165362861.05 │
│ authz/allow  │ {"method":"POST","path":"\/data","username":"alice"}            │  15 │  117321.46666666666 │             89668 │          52837 │         345571 │   77995.11690380427 │  6083238260.838095 │  141172.46666666667 │               98556 │            59621 │           534114 │  129502.35981074777 │ 16770861196.552382 │
│ authz/allow  │ {"method":"POST","path":"\/data\/tester","username":"alice"}    │  14 │   83655.28571428571 │             60761 │          43016 │         191368 │   45983.35676746964 │ 2114469099.6043956 │   93852.92857142857 │               87960 │            65741 │           144803 │   22680.08657039605 │ 514386326.84065926 │
│ authz/allow  │ {"method":"GET","path":"\/data\/alice","username":"alice"}      │  13 │   92454.23076923077 │             95246 │          45144 │         183857 │  40564.367711810504 │ 1645467927.8589745 │  103937.46153846153 │              100375 │            75387 │           154519 │   25139.10083454122 │   631974390.769231 │
│ authz/allow  │ {"method":"GET","path":"\/data\/tester","username":"alice"}     │  12 │            90462.25 │             87782 │          61034 │         140936 │  26014.183219316765 │  676737728.5681819 │            113224.5 │             97866.5 │            75801 │           325483 │    67541.9330025968 │  4561912713.727273 │
│ authz/allow  │ {"method":"DELETE","path":"\/data\/alice","username":"admin"}   │  12 │   91427.66666666667 │             98612 │          54061 │         127750 │   23249.67445063707 │  540547362.0606061 │  144778.66666666666 │             98544.5 │            70226 │           554907 │  136096.83219834414 │ 18522347734.424244 │
│ authz/allow  │ {"method":"GET","path":"\/data","username":"tester"}            │  11 │   92151.81818181818 │             97943 │          51892 │         131860 │  27326.587517720473 │  746742385.3636363 │  107157.90909090909 │               97382 │            61910 │           235499 │   46080.91117036326 │ 2123450374.2909093 │
│ authz/allow  │ {"method":"GET","path":"\/data\/tester","username":"admin"}     │  11 │  120306.09090909091 │            110025 │          51297 │         281215 │   67437.02383328397 │  4547752183.490909 │              163437 │              114029 │            85413 │           407970 │   98598.18272767506 │       9721601637.2 │
│ authz/allow  │ {"method":"DELETE","path":"\/data\/tester","username":"tester"} │  11 │   82275.18181818182 │             84145 │          47219 │         121725 │  25986.189227426872 │  675282030.5636364 │   96155.90909090909 │               99811 │            57641 │           142736 │  22733.041954188822 │  516791196.4909091 │
│ authz/allow  │ {"method":"POST","path":"\/data\/tester","username":"admin"}    │  11 │   94619.36363636363 │             98149 │          57030 │         140677 │   23429.18071240532 │  548926508.8545455 │  133027.45454545456 │              100069 │            75804 │           305015 │   72250.15846953368 │  5220085398.872728 │
│ authz/allow  │ {"method":"GET","path":"\/data\/alice","username":"tester"}     │  11 │   86854.90909090909 │             73734 │          48792 │         139809 │   32142.97362240944 │ 1033170753.2909092 │  154493.54545454544 │              104575 │            82205 │           393502 │  117824.52497537482 │ 13882618685.672726 │
│ authz/allow  │ {"method":"GET","path":"\/data","username":"admin"}             │  10 │               85983 │             95825 │          49980 │         113254 │  21873.032371189667 │  478429545.1111111 │            138333.4 │              106563 │            71320 │           271795 │   68056.96013095697 │  4631749822.266666 │
│ authz/allow  │ {"method":"POST","path":"\/data\/alice","username":"admin"}     │  10 │             69965.4 │           62649.5 │          45211 │         109077 │   20746.88887627358 │  430433398.0444444 │            123593.2 │               98234 │            80887 │           311144 │   69577.73636220777 │   4841061397.28889 │
│ authz/allow  │ {"method":"GET","path":"\/data","username":"alice"}             │   9 │  103694.88888888889 │             98047 │          81674 │         148531 │    21980.9916145999 │  483163992.3611111 │  120203.22222222222 │               96103 │            84437 │           309797 │   71736.53148810893 │  5146129949.944445 │
│ authz/allow  │ {"method":"DELETE","path":"\/data","username":"alice"}          │   9 │  106180.22222222222 │             81311 │          60833 │         286378 │   71487.85121574465 │  5110512871.444445 │  192175.44444444444 │              133812 │            71771 │           403362 │  122568.98565411144 │ 15023156244.277777 │
│ authz/allow  │ {"method":"GET","path":"\/data\/alice","username":"admin"}      │   9 │  110788.88888888889 │            100635 │          49799 │         235817 │   61542.01140165238 │  3787419167.361111 │  123497.22222222222 │              103933 │            73378 │           200997 │   47054.01292073232 │  2214080131.944444 │
│ authz/allow  │ {"method":"POST","path":"\/data\/alice","username":"tester"}    │   9 │  111747.44444444444 │            109441 │          51023 │         217431 │   62410.04448626661 │ 3895013652.7777777 │  236823.88888888888 │               99013 │            79525 │           675477 │   214280.6945331546 │  45916216049.61111 │
│ authz/allow  │ {"method":"DELETE","path":"\/data\/alice","username":"tester"}  │   8 │          108390.375 │            107732 │          45703 │         188560 │   44423.06116980716 │ 1973408363.6964285 │          122922.125 │               97772 │            71569 │           267792 │    66298.3899469178 │  4395476509.553572 │
│ authz/allow  │ {"method":"DELETE","path":"\/data","username":"admin"}          │   8 │            82947.75 │           84009.5 │          49639 │         122284 │   25639.80544694407 │  657399623.3571428 │               92774 │               97583 │            45673 │           128981 │   24608.02780162836 │  605555032.2857143 │
│ authz/allow  │ {"method":"POST","path":"\/data","username":"tester"}           │   8 │            97475.25 │           75006.5 │          49007 │         262839 │   71125.27976495317 │  5058805421.642858 │            111350.5 │             95432.5 │            83166 │           240382 │  52816.592008842934 │  2789592391.428571 │
│ authz/allow  │ {"method":"DELETE","path":"\/data\/tester","username":"alice"}  │   8 │           62438.875 │             60946 │          52273 │          79058 │   8330.110862536156 │  69390746.98214285 │              165191 │              108591 │            81648 │           306776 │   91835.14038287771 │  8433693009.142858 │
│ authz/allow  │ {"method":"DELETE","path":"\/data\/alice","username":"alice"}   │   8 │            89116.75 │           86302.5 │          72160 │         116438 │  16006.629749218648 │ 256212195.92857143 │           104126.75 │              101286 │            70737 │           163891 │  30780.657376021067 │        947448868.5 │
│ authz/allow  │ {"method":"POST","path":"\/data","username":"admin"}            │   6 │            129155.5 │          120553.5 │          57287 │         227518 │   70881.27179657543 │       5024154691.5 │  153119.33333333334 │             97944.5 │            84724 │           388007 │   117891.5036135627 │ 13898406624.266666 │
│ authz/allow  │ {"method":"POST","path":"\/data\/tester","username":"tester"}   │   4 │               53357 │             56031 │          42018 │          59348 │   7881.352929541983 │           62115724 │           125738.75 │               83659 │            63466 │           272171 │   98159.86646410028 │      9635359384.25 │
│ authz/allow  │ {"method":"DELETE","path":"\/data","username":"tester"}         │   4 │            67928.75 │             64790 │          45608 │          96527 │  22303.084381238994 │  497427572.9166667 │           106618.75 │            102391.5 │            97261 │           124431 │  12185.334091302817 │ 148482366.91666666 │
│ authz/allow  │ {"method":"GET","path":"\/data\/tester","username":"tester"}    │   3 │  113392.33333333333 │            102932 │          80826 │         156419 │  38866.944082772105 │ 1510639342.3333335 │  103239.66666666667 │              105040 │            86454 │           118225 │  15961.829792769164 │  254780010.3333333 │
│ authz/allow  │ {"method":"POST","path":"\/data\/alice","username":"alice"}     │   2 │             63798.5 │           63798.5 │          52612 │          74985 │  15820.100015486627 │        250275564.5 │               96072 │               96072 │            94624 │            97520 │  2047.7812383162416 │            4193408 │
└──────────────┴─────────────────────────────────────────────────────────────────┴─────┴─────────────────────┴───────────────────┴────────────────┴────────────────┴─────────────────────┴────────────────────┴─────────────────────┴─────────────────────┴──────────────────┴──────────────────┴─────────────────────┴────────────────────┘
```

## Things not mentioned

- There's CSV and JSON outputs via `--output` and `--format` for further data analysis!
- You can pipe the JSON output into `eopa eval -I` and have your own policy to be used for
  CI/CD pipelines to automatically determine if the impact associated with a policy change
  is acceptable.
